<!DOCTYPE html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>JavaEE Sample::Batch::Batch Listeners</title><link rel="stylesheet" href="http://javaee.support/stylesheets/foundation-icons.css"><link rel="stylesheet" href="http://javaee.support/stylesheets/app.css"><script src="http://javaee.support/javascripts/vendor/custom.modernizr.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><link rel="author" type="text/plain" href="http://javaee.support/humans.txt"><link rel="author" href="https://plus.google.com/101195212405190467512"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Batch Listeners"><meta name="twitter:description" content="Batch Listeners - Applying Listeners to Job, Chunk, Step, Reader, Processor and Writer"></head><body class="antialiased"><nav class="top-bar"><ul class="title-area"><li class="name"><h1><a href="http://javaee.support/">JavaEE Samples</a></h1></li><li class="toggle-topbar"><a href="#"><i class="fi-home"></i></a></li></ul><section class="top-bar-section"><ul class="right"><li class="divider"><li><a href="http://javaee.support/contributors">Contributors <i class="fi-torsos-male-female"></i></a></li></li></ul></section></nav><div class="container"><header><div class="row"><div class="large-10 columns"><h2>Batch Listeners</h2></div><div class="large-2 columns"><div class="action right"><a class="button radius round success" data-reveal-id="run">Run <i class="fi-play"></i></a><div id="run" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to run the sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/batch/batch-listeners/">javaee7-samples</a> <i class="fi-social-github"></i> GitHub repository. The first thing we need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/batch/batch-listeners/</code></pre>Now we are ready to start testing. You can run all the tests in this sample by executing:<pre class="highlight"><code>mvn test</code></pre>Or you can run individual tests by executing one of the following:<pre class="highlight"><code>mvn test -Dtest=BatchListenersTest</code></pre></hr></div></div></div></div><div class="row"><div class="large-10 columns"><h3>Batch Listeners - Applying Listeners to Job, Chunk, Step, Reader, Processor and Writer</h3></div></div><div class="sub"><div class="row"><div class="large-10 columns specifications"><ul class="inline-list"><li>Specifications in use:</li><li><ul class="inline-list"></ul><li><a href="http://javaee.support/#Batch" title="Batch Processing for Java Platform 1.0">Batch</a></li><li><a href="http://javaee.support/#CDI" title="Context and Dependency Injection 1.1">CDI</a></li></li></ul></div><div class="large-2 columns contributors"><ul class="inline-list"><li itemscope="" itemtype="http://data-vocabulary.org/Person"><meta itemprop="role" content="author"><meta itemprop="name" content="Arun-gupta"><meta itemprop="affiliation" content="Red Hat Software"><img class="photo" title="Arun-gupta" src="http://gravatar.com/avatar/268f57c236bb50c0f6e12ac38adc9d81?s=25" itemprop="photo"></li><li itemscope="" itemtype="http://data-vocabulary.org/Person"><meta itemprop="role" content="author"><meta itemprop="name" content="Roberto Cortez"><meta itemprop="affiliation" content=""><img class="photo" title="Roberto Cortez" src="http://gravatar.com/avatar/d9a06fda174419c0dffb982f226518c2?s=25" itemprop="photo"></li></ul></div></div></div><script type="text/javascript">//$(function() { activateGuideMenuControl() })</script></header><div class="row"><div class="large-12 columns"><div id="test"><div class="row"><div class="large-7 columns"><h4>BatchListenersTest</h4></div><div class="large-3 columns"><ul class="inline-list" style="margin-left:0em;"><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on GlassFish 4.0" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly 8.0.0.Final" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly 8.1.0.Final" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly nightly" style="color: green"></i></li></ul></div><div class="large-2 columns"><a class="right" href="https://github.com/javaee-samples/javaee7-samples/edit/master/batch/batch-listeners/src/test/java/org/javaee7/batch/batch/listeners/BatchListenersTest.java"><i class="fi-page-edit"></i></a></div></div><div class="paragraph">
<p>The Batch specification, provides several listeners to notify about specific event occurring during the batch
processing execution.</p>
</div>
<div class="paragraph">
<p>Events can be caught via extending the following classes, for the appropriate batch lifecycle event:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/listener/AbstractJobListener.html" title="javax.batch.api.listener.AbstractJobListener">AbstractJobListener</a></code></p>
</li>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/listener/AbstractStepListener.html" title="javax.batch.api.listener.AbstractStepListener">AbstractStepListener</a></code></p>
</li>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/listener/AbstractChunkListener.html" title="javax.batch.api.chunk.listener.AbstractChunkListener">AbstractChunkListener</a></code></p>
</li>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/listener/AbstractItemReadListener.html" title="javax.batch.api.chunk.listener.AbstractItemReadListener">AbstractItemReadListener</a></code></p>
</li>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/listener/AbstractItemProcessListener.html" title="javax.batch.api.chunk.listener.AbstractItemProcessListener">AbstractItemProcessListener</a></code></p>
</li>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/listener/AbstractItemWriteListener.html" title="javax.batch.api.chunk.listener.AbstractItemWriteListener">AbstractItemWriteListener</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Job Listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named()
public class MyJobListener extends AbstractJobListener {

    public MyJobListener();

    @Override()
    public void beforeJob();

    @Override()
    public void afterJob();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Allows you to execute code before and after the job execution. Useful to setup and clear resources needed by the job.</p>
</div>
<div class="paragraph">
<p>The Step Listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named()
public class MyStepListener extends AbstractStepListener {

    public MyStepListener();

    @Override()
    public void beforeStep() throws Exception;

    @Override()
    public void afterStep() throws Exception;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Allows you to execute code before and after the step execution. Useful to setup and clear resources needed by the
step.</p>
</div>
<div class="paragraph">
<p>The Chunk Listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named()
public class MyChunkListener extends AbstractChunkListener {

    public MyChunkListener();

    @Override()
    public void beforeChunk() throws Exception;

    @Override()
    public void afterChunk() throws Exception;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Allows you to execute code before and after the chunk processing. Useful to setup and clear resources needed by the
chunk.</p>
</div>
<div class="paragraph">
<p>The Read Listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named()
public class MyItemReadListener extends AbstractItemReadListener {

    public MyItemReadListener();

    @Override()
    public void beforeRead() throws Exception;

    @Override()
    public void afterRead(Object item) throws Exception;

    @Override()
    public void onReadError(Exception ex) throws Exception;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Allows you to execute code before and after reading a element as well if an error occurs reading that element. Useful
to setup additional resources and add additional information to the object reading. You can also provide some logic
to treat a failed object read.</p>
</div>
<div class="paragraph">
<p>The Processor Listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named()
public class MyItemProcessorListener extends AbstractItemProcessListener {

    public MyItemProcessorListener();

    @Override()
    public void beforeProcess(Object item) throws Exception;

    @Override()
    public void afterProcess(Object item, Object result) throws Exception;

    @Override()
    public void onProcessError(Object item, Exception ex) throws Exception;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Allows you to execute code before and after processing a element as well if an error occurs processing that element.
Useful to setup additional resources and add additional information to the object processing. You can also provide
some logic to  treat a failed object processing.</p>
</div>
<div class="paragraph">
<p>The Writer Listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named()
public class MyItemWriteListener extends AbstractItemWriteListener {

    public MyItemWriteListener();

    @Override()
    public void beforeWrite(List items) throws Exception;

    @Override()
    public void afterWrite(List items) throws Exception;

    @Override()
    public void onWriteError(List items, Exception ex) throws Exception;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Allows you to execute code before and after writing a element as well if an error occurs writing that element.
Useful to setup additional resources and add additional information to the object writing. You can also provide
some logic to  treat a failed object write.</p>
</div>
<div class="paragraph">
<p>The <code>listeners</code> element can be used at the <code>step</code> level or the <code>job</code> level to define which listeners to run for each
batch processing event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;job id="myJob" xmlns="http://xmlns.jcp.org/xml/ns/javaee" version="1.0"&gt;
    &lt;listeners&gt;
        &lt;listener ref="myJobListener"/&gt;
    &lt;/listeners&gt;
    &lt;step id="myStep" &gt;
        &lt;listeners&gt;
            &lt;listener ref="myStepListener"/&gt;
            &lt;listener ref="myChunkListener"/&gt;
            &lt;listener ref="myItemReadListener"/&gt;
            &lt;listener ref="myItemProcessorListener"/&gt;
            &lt;listener ref="myItemWriteListener"/&gt;
        &lt;/listeners&gt;
        &lt;chunk item-count="3"&gt;
            &lt;reader ref="myItemReader"/&gt;
            &lt;processor ref="myItemProcessor"/&gt;
            &lt;writer ref="myItemWriter"/&gt;
        &lt;/chunk&gt;
    &lt;/step&gt;
&lt;/job&gt;</code></pre>
</div>
</div><div class="paragraph">
<p>We&#8217;re just going to deploy the application as a <code>web archive</code>. Note the inclusion of the following files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-file" data-lang="file">/META-INF/batch-jobs/myJob.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>myJob.xml</code> file is needed for running the batch definition.</p>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Deployment
public static WebArchive createDeployment() {
    WebArchive war = ShrinkWrap.create(WebArchive.class)
            .addClass(BatchTestHelper.class)
            .addPackage("org.javaee7.batch.batch.listeners")
            .addAsWebInfResource(EmptyAsset.INSTANCE, ArchivePaths.create("beans.xml"))
            .addAsResource("META-INF/batch-jobs/myJob.xml");
    System.out.println(war.toString(true));
    return war;
}</code></pre>
</div>
</div><div class="paragraph">
<p>In the test, we&#8217;re just going to invoke the batch execution and wait for completion. To validate the test
expected behaviour we need to query the <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/runtime/Metric.html" title="javax.batch.runtime.Metric">Metric</a></code> object available in the step execution and
also verify if the listeners were executed correctly via a <code>CountDownLatch</code> wait.</p>
</div>
<div class="paragraph">
<p>The batch process itself will read and process 10 elements from numbers  1 to 10, but only write the odd
elements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each listener will decrement the total value of the <code>CountDownLatch</code>, until all the predicted events are
executed. The number of predicted events is 60:</p>
<div class="ulist">
<ul>
<li>
<p><code>MyJobListener</code> executes 2 times, 1 for <code>MyJobListener#beforeJob</code> and 1 more for <code>MyJobListener#afterJob</code>.</p>
</li>
<li>
<p><code>MyStepListener</code> executes 2 times, 1 for <code>MyStepListener#beforeStep</code> and 1 more for <code>MyStepListener#afterStep</code>.</p>
</li>
<li>
<p><code>MyChunkListener</code> executes 8 times, 4 for <code>MyChunkListener#beforeChunk</code> and 4 more
for <code>MyChunkListener#afterChunk</code>. Chunk size is set to 3 and the total elements is 10, so 10/3 = 3 and 1 more
for the last element, means 4 for each chunk listener event.</p>
</li>
<li>
<p><code>MyItemReader</code> executes 22 times, 10 elements in total plus an empty read, so <code>MyItemReadListener#beforeRead</code>
executes 11 times and <code>MyItemReadListener#afterRead</code> the other 11 times.</p>
</li>
<li>
<p><code>MyItemProcessorListener</code> executes 20 times, 10 elements read in total,
so <code>MyItemProcessorLister#beforeProcess</code> executes 10 times
and <code>MyItemProcessorLister#afterProcess</code> the other 10 times.</p>
</li>
<li>
<p><code>MyItemWriterListener</code> executed 6 times, 3 times for <code>MyItemWriterListener#beforeWrite</code> and another 3 times
for <code>MyItemWriterListener#afterWrite</code>. This one is a bit more tricky, since not every element needs to be
written. Looking at <code>MyItemProcessor</code>, only even records are going to be written. We also need to take into
account the elements read per chunk, so: Chunk[1] read and process [1,2,3] and wrote [2,6], Chunk[2] read and
process [4,5,6] and wrote [10], Chunk[3] read and process [7,8,9] and wrote [14,18], Chunk[4] read and process
[10] and did not wrote anything, so only 3 writes for the full processing.</p>
</li>
<li>
<p>Total: 2 + 2 + 8 + 22 + 20 + 6 = 60</p>
</li>
</ul>
</div>
</li>
</ul>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Test
public void testBatchListeners() throws Exception {
    JobOperator jobOperator = BatchRuntime.getJobOperator();
    Long executionId = jobOperator.start("myJob", new Properties());
    JobExecution jobExecution = jobOperator.getJobExecution(executionId);

    BatchTestHelper.keepTestAlive(jobExecution);

    List&lt;StepExecution&gt; stepExecutions = jobOperator.getStepExecutions(executionId);
    for (StepExecution stepExecution : stepExecutions) {
        if (stepExecution.getStepName().equals("myStep")) {
            Map&lt;Metric.MetricType, Long&gt; metricsMap = BatchTestHelper.getMetricsMap(stepExecution.getMetrics());

            assertEquals(10L, metricsMap.get(Metric.MetricType.READ_COUNT).longValue());
            assertEquals(10L / 2L, metricsMap.get(Metric.MetricType.WRITE_COUNT).longValue());
            assertEquals(10L / 3 + (10L % 3 &gt; 0 ? 1 : 0), metricsMap.get(Metric.MetricType.COMMIT_COUNT).longValue());
        }
    }

    assertTrue(BatchListenerRecorder.batchListenersCountDownLatch.await(0, TimeUnit.SECONDS));
    assertEquals(jobExecution.getBatchStatus(), BatchStatus.COMPLETED);
}</code></pre>
</div>
</div></div><script type="text/javascript">$(function() {
  hljs.initHighlightingOnLoad();
})</script></div></div><div class="row"><div class="large-12 columns"><div class="large-6 columns"><h3>Share the Knowledge</h3>Find this sample useful? <a href="http://twitter.com/home/?status=Just%20read%20the%20%23JavaEE-Sample%20%22Batch::Batch%20Listeners%22%20and%20learned%20something%20new!%20http://javaee.support/sample/batch-batch-listeners/">Share on <i class="fi-social-twitter"></i></a><p>There's a lot more about JavaEE to cover. If you're ready to learn more, check out the <a href="http://javaee.support/">other available samples</a>.</p></div><div class="large-6 columns"><h3>Help Improve</h3>Find a bug in the sample? Something missing? You can fix it by <a href="https://github.com/javaee-samples/javaee7-samples/edit/master/batch/batch-listeners/src/test/java/org/javaee7/batch/batch/listeners/BatchListenersTest.java">editing the source</a>, making the correction and sending a pull request. Or report the problem to the <a href="https://github.com/javaee-samples/javaee7-samples/issues">issue tracker</a></div></div></div><div class="row"><div class="large-12 columns changes"><h4>Recent Changelog</h4><ul><li>Jul 05, 2014: Removed header license for batch xml files <em>by Roberto Cortez</em></li><li>Jun 22, 2014: Removed header license. the licensing is now referenced in the license file in the root of the project <em>by Roberto Cortez</em></li><li>Jun 20, 2014: Added fqn to java ee api references to generate direct links to javadocs <em>by radcortez</em></li><li>Jun 19, 2014: Documentation clarifications and typos <em>by radcortez</em></li><li>May 27, 2014: Added documentation to batch-listeners project <em>by Roberto Cortez</em></li><li>Dec 31, 2013: Code style issues <em>by Roberto Cortez</em></li><li>Dec 31, 2013: Removed servlets and jsp's <em>by Roberto Cortez</em></li><li>Dec 04, 2013: Changed asserts for countdownlatch <em>by Roberto Cortez</em></li><li>Dec 04, 2013: Refactored batch tests to use countdownlatch instead of boolean static variables to monitor execution <em>by Roberto Cortez</em></li><li>Nov 26, 2013: Simplified listener tests <em>by Roberto Cortez</em></li></ul></div></div><div id="improve" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to help improve this sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/batch/batch-listeners/">javaee7-samples</a> <i class="fi-social-github"></i>GitHub repository. The first thing you need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/batch/batch-listeners/</code></pre><p>Do the changes as you see fit and send a pull request!</p><p>Good Luck!</p></hr></div></div><footer style="max-width: 100%"><div class="row"><div class="large-6 columns" style="margin-bottom: .75em; margin-top: .75em"><ul class="unstyled"><li>&#169; Copyright 2013-2014 JavaEE Samples.</li><li><i class="fi-like"></i>&nbsp;Mixed with <a href="http://foundation.zurb.com/">Foundation</a>. Baked by <a href="http://awestruct.org">Awestruct</a>.</li><li><i class="fi-share"></i>&nbsp;Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</li></ul></div></div></footer><script src="http://javaee.support/javascripts/foundation/foundation.js"></script><script src="http://javaee.support/javascripts/foundation/foundation.topbar.js"></script><script src="http://javaee.support/javascripts/foundation/foundation.reveal.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/styles/pojoaque.css"><script type="text/javascript">$(document).foundation()</script><script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount','UA-18727998-5']);
_gaq.push(['_trackPageview']);
(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
</body>