<!DOCTYPE html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>JavaEE Sample::JPA::JPA Listeners</title><link rel="stylesheet" href="http://javaee-samples.github.io/stylesheets/foundation-icons.css"><link rel="stylesheet" href="http://javaee-samples.github.io/stylesheets/app.css"><script src="http://javaee-samples.github.io/javascripts/vendor/custom.modernizr.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><link rel="author" type="text/plain" href="http://javaee-samples.github.io/humans.txt"><link rel="author" href="https://plus.google.com/101195212405190467512"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="JPA Listeners"><meta name="twitter:description" content="Invocation examples of all the available Entity Listeners"></head><body class="antialiased"><nav class="top-bar"><ul class="title-area"><li class="name"><h1><a href="http://javaee-samples.github.io/">JavaEE Samples</a></h1></li><li class="toggle-topbar"><a href="#"><i class="fi-home"></i></a></li></ul><section class="top-bar-section"><ul class="right"><li class="divider"><li><a href="http://javaee-samples.github.io/contributors">Contributors <i class="fi-torsos-male-female"></i></a></li></li></ul></section></nav><div class="container"><header><div class="row"><div class="large-10 columns"><h2>JPA Listeners</h2></div><div class="large-2 columns"><div class="action right"><a class="button radius round success" data-reveal-id="run">Run <i class="fi-play"></i></a><div id="run" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to run the sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/jpa/listeners/">javaee7-samples</a> <i class="fi-social-github"></i>GitHub repository. The first thing we need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/jpa/listeners/</code></pre>Now we are ready to start testing. You can run all the tests in this sample by executing:<pre class="highlight"><code>mvn test</code></pre>Or you can run individual tests by executing one of the following:<pre class="highlight"><code>mvn test -Dtest=JpaListenersTest</code></pre></hr></div></div></div></div><div class="row"><div class="large-10 columns"><h3>Invocation examples of all the available Entity Listeners</h3></div></div><div class="sub"><div class="row"><div class="large-10 columns specifications"><ul class="inline-list"><li>Specifications in use:</li><li><ul class="inline-list"></ul><li><a href="http://javaee-samples.github.io/#CDI" title="Context and Dependency Injection 1.1">CDI</a></li><li><a href="http://javaee-samples.github.io/#EJB" title="Enterprise JavaBeans 3.2">EJB</a></li><li><a href="http://javaee-samples.github.io/#JPA" title="Java Persistence API 2.1">JPA</a></li><li><a href="http://javaee-samples.github.io/#validation" title="Bean Validation 1.1">validation</a></li></li></ul></div><div class="large-2 columns contributors"><ul class="inline-list"><li itemscope="" itemtype="http://data-vocabulary.org/Person"><meta itemprop="role" content="author"><meta itemprop="name" content="Arun Gupta"><meta itemprop="affiliation" content="Red Hat Software"><img class="photo" title="Arun Gupta" src="http://gravatar.com/avatar/268f57c236bb50c0f6e12ac38adc9d81?s=25" itemprop="photo"></li><li itemscope="" itemtype="http://data-vocabulary.org/Person"><meta itemprop="role" content="author"><meta itemprop="name" content="Roberto Cortez"><meta itemprop="affiliation" content=""><img class="photo" title="Roberto Cortez" src="http://gravatar.com/avatar/d9a06fda174419c0dffb982f226518c2?s=25" itemprop="photo"></li></ul></div></div></div><script type="text/javascript">//$(function() { activateGuideMenuControl() })</script></header><div class="row"><div class="large-12 columns"><div id="test"><div class="row"><div class="large-7 columns"><h4>JpaListenersTest</h4></div><div class="large-3 columns"><ul class="inline-list" style="margin-left:0em;"><li style="margin-left: 0.3em"><i class="fi-dislike" title="Not all tests pass on GlassFish 4.0" style="color: red"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly 8.0.0.Final" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly 8.1.0.Final" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly nightly" style="color: green"></i></li></ul></div><div class="large-2 columns"><a class="right" href="https://github.com/javaee-samples/javaee7-samples/edit/master/jpa/listeners/src/test/java/org/javaee7/jpa/listeners/JpaListenersTest.java"><i class="fi-page-edit"></i></a></div></div><div class="paragraph">
<p>In this sample we&#8217;re going to query a simple <code>JPA Entity</code>, using the <code>JPA EntityManager</code> and perform a findAll,
persist, merge, and remove operations. By calling these operations we want to demonstrate the behaviour of <code>Entity
Listener Methods</code>: <code>@PostLoad</code>, <code>@PrePersist</code>, <code>@PostPersist</code>, <code>@PreUpdate</code>, <code>@PostUpdate</code>, <code>@PreRemove</code>,
<code>@PostRemove</code> defined on <code>MovieListener</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">
public class MovieListener {

    public MovieListener() {
        super();
    }
    public static CountDownLatch entityListenersCountDownLatch = new CountDownLatch(26);
    public static boolean postLoadInvoked;
    public static boolean prePersistInvoked;
    public static boolean postPersistInvoked;
    public static boolean preUpdateInvoked;
    public static boolean postUpdateInvoked;
    public static boolean preRemoveInvoked;
    public static boolean postRemoveInvoked;

    @PostLoad()
    public void newMovieLoad(Movie movie) {
        postLoadInvoked = true;
        entityListenersCountDownLatch.countDown();
        System.out.println("## Movie loaded: " + movie.getName());
    }

    @PrePersist()
    public void newMovieAlertBefore(Movie movie) {
        prePersistInvoked = true;
        entityListenersCountDownLatch.countDown();
        System.out.println("## Ready to create new movie: " + movie.getName());
    }

    @PostPersist()
    public void newMovieAlertAfter(Movie movie) {
        postPersistInvoked = true;
        entityListenersCountDownLatch.countDown();
        System.out.println("## New movie created: " + movie.getName());
    }

    @PreUpdate()
    public void updateMovieAlertBefore(Movie movie) {
        preUpdateInvoked = true;
        entityListenersCountDownLatch.countDown();
        System.out.println("## Ready to update movie: " + movie.getName());
    }

    @PostUpdate()
    public void updateMovieAlertAfter(Movie movie) {
        postUpdateInvoked = true;
        entityListenersCountDownLatch.countDown();
        System.out.println("## Movie updated: " + movie.getName());
    }

    @PreRemove()
    public void deleteMovieAlertBefore(Movie movie) {
        preRemoveInvoked = true;
        entityListenersCountDownLatch.countDown();
        System.out.println("## Ready to delete movie: " + movie.getName());
    }

    @PostRemove()
    public void deleteMovieAlertAfter(Movie movie) {
        postRemoveInvoked = true;
        entityListenersCountDownLatch.countDown();
        System.out.println("## Movie deleted: " + movie.getName());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>JPA Entity</code>, represents a Movie which has a name and a comma separated list of actors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">
@Entity()
@Table(name = "MOVIE_LISTENER")
@XmlRootElement()
@NamedQueries({@NamedQuery(name = "Movie.findAll", query = "SELECT m FROM Movie m"), @NamedQuery(name = "Movie.findById", query = "SELECT m FROM Movie m WHERE m.id = :id"), @NamedQuery(name = "Movie.findByName", query = "SELECT m FROM Movie m WHERE m.name = :name"), @NamedQuery(name = "Movie.findByActors", query = "SELECT m FROM Movie m WHERE m.actors = :actors")})
@EntityListeners(MovieListener.class)
public class Movie implements Serializable {
    private static final long serialVersionUID = 1L;
    @Id()
    @NotNull()
    private Integer id;
    @NotNull()
    @Size(min = 1, max = 50)
    private String name;
    @NotNull()
    @Size(min = 1, max = 200)
    private String actors;

    public Movie() {
    }

    public Movie(Integer id) {
        this.id = id;
    }

    public Movie(Integer id, String name, String actors) {
        this.id = id;
        this.name = name;
        this.actors = actors;
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getActors() {
        return actors;
    }

    public void setActors(String actors) {
        this.actors = actors;
    }

    @Override()
    public boolean equals(Object o) {
        if (this == o) {
            return true;
        }
        if (o == null || getClass() != o.getClass()) {
            return false;
        }
        Movie movie = (Movie)o;
        return id.equals(movie.id);
    }

    @Override()
    public int hashCode() {
        return id.hashCode();
    }

    @Override()
    public String toString() {
        return name;
    }
}</code></pre>
</div>
</div><div class="paragraph">
<p>We&#8217;re just going to deploy the application as a <code>web archive</code>. Note the inclusion of the following files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="file language-file">/META-INF/persistence.xml
/META-INF/create.sql
/META-INF/drop.sql
/META-INF/load.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>persistence.xml</code> file is needed of course for the persistence unit definition. A datasource is not
needed, since we can now use the new default datasource available in <code>JEE7</code>. We&#8217;re also using the new
<code>javax.persistence.schema-generation.*</code> propertires to create, populate and drop the database.</p>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Deployment
public static WebArchive createDeployment() {
    WebArchive war = ShrinkWrap.create(WebArchive.class)
                               .addPackage("org.javaee7.jpa.listeners")
                               .addAsResource("META-INF/persistence.xml")
                               .addAsResource("META-INF/create.sql")
                               .addAsResource("META-INF/drop.sql")
                               .addAsResource("META-INF/load.sql");
    System.out.println(war.toString(true));
    return war;
}</code></pre>
</div>
</div><div class="paragraph">
<p>In the test, we&#8217;re just going to invoke the different operations in sequence keeping in mind that each
invocation might be dependent of the previous invoked operation.</p>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Test
public void testListeners() throws Exception {
    List&lt;Movie&gt; movies = movieBean.listMovies();    <b>(1)</b>
    assertEquals(4, movies.size());

    assertFalse(prePersistInvoked);
    assertFalse(postPersistInvoked);
    movieBean.createMovie();                        <b>(2)</b>
    assertTrue(prePersistInvoked);
    assertTrue(postPersistInvoked);

    movies = movieBean.listMovies();                <b>(3)</b>
    assertEquals(5, movies.size());
    assertTrue(movies.contains(new Movie(5)));


    assertFalse(preUpdateInvoked);
    assertFalse(postUpdateInvoked);
    movieBean.updateMovie();                        <b>(4)</b>
    assertTrue(preUpdateInvoked);
    assertTrue(postUpdateInvoked);

    movies = movieBean.listMovies();                <b>(5)</b>
    assertEquals(5, movies.size());
    assertEquals("Inception2", movies.get(2).getName());

    assertFalse(preRemoveInvoked);
    assertFalse(postRemoveInvoked);
    movieBean.deleteMovie();                        <b>(6)</b>
    assertTrue(preRemoveInvoked);
    assertTrue(postRemoveInvoked);

    movies = movieBean.listMovies();                <b>(7)</b>
    assertFalse(movies.isEmpty());
    assertEquals(4, movies.size());
    assertFalse(movies.contains(new Movie(3)));

    assertTrue(MovieListener.entityListenersCountDownLatch.await(0, TimeUnit.SECONDS));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>4 movies in the database, so <code>@PostLoad</code> method called 4x</p>
</li>
<li>
<p>On persist both <code>@PrePersist</code> and <code>@PostPersist</code> are called</p>
</li>
<li>
<p>5 movies now, so <code>@PostLoad</code> method called 5x</p>
</li>
<li>
<p>On merge both <code>@PreUpdate</code> and <code>@PostUpdate</code> are called</p>
</li>
<li>
<p>Still 5 mpvies, so <code>@PostLoad</code> method called again 5x</p>
</li>
<li>
<p>On remove both <code>@PreRemove</code> and <code>@PostRemove</code> are called</p>
</li>
<li>
<p>4 movies now, so <code>@PostLoad</code> method called 4x</p>
</li>
</ol>
</div></div><script type="text/javascript">$(function() {
  hljs.initHighlightingOnLoad();
})</script></div></div><div class="row"><div class="large-12 columns"><div class="large-6 columns"><h3>Share the Knowledge</h3>Find this sample useful? <a href="http://twitter.com/home/?status=Just%20read%20the%20%23JavaEE-Sample%20%22JPA::JPA%20Listeners%22%20and%20learned%20something%20new!%20http://javaee-samples.github.io/sample/jpa-listeners/">Share on <i class="fi-social-twitter"></i></a><p>There's a lot more about JavaEE to cover. If you're ready to learn more, check out the <a href="http://javaee-samples.github.io/">other available samples</a>.</p></div><div class="large-6 columns"><h3>Help Improve</h3>Find a bug in the sample? Something missing? You can fix it by <a href="https://github.com/javaee-samples/javaee7-samples/edit/master/jpa/listeners/src/test/java/org/javaee7/jpa/listeners/JpaListenersTest.java">editing the source</a>, making the correction and sending a pull request. Or report the problem to the <a href="https://github.com/javaee-samples/javaee7-samples/issues">issue tracker</a></div></div></div><div class="row"><div class="large-12 columns changes"><h4>Recent Changelog</h4><ul><li><div>Jan 21, 2014: Updated javadoc <em>by Roberto Cortez</em></div></li><li><div>Jan 16, 2014: Added test for jpa listeners project <em>by Roberto Cortez</em></div></li><li><div>Nov 09, 2013: Removing try-with-resources to allow any errors to show up on servletoutputstream <em>by Arun Gupta</em></div></li><li><div>Oct 30, 2013: Fixing the namespace and version <em>by Arun Gupta</em></div></li><li><div>Sep 17, 2013: Removing netbeans configuration file <em>by Arun Gupta</em></div></li><li><div>Sep 12, 2013: Fixing namespace from java.sun.com -> xmlns.jcp.org <em>by Arun Gupta</em></div></li><li><div>Sep 12, 2013: Fixing namespace from java.sun.com -> xmlns.jcp.org <em>by Arun Gupta</em></div></li><li><div>Sep 12, 2013: Better output message <em>by Arun Gupta</em></div></li><li><div>Sep 12, 2013: Using cdi 1.1 "all" style beans.xml <em>by Arun Gupta</em></div></li><li><div>Aug 27, 2013: Moving the source code from http://svn.java.net/svn/glassfish~svn/branches/arun/javaee7-samples/samples/ <em>by Arun Gupta</em></div></li></ul></div></div><div id="improve" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to help improve this sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/jpa/listeners/">javaee7-samples</a> <i class="fi-social-github"></i>GitHub repository. The first thing you need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/jpa/listeners/</code></pre><p>Do the changes as you see fit and send a pull request!</p><p>Good Luck!</p></hr></div></div><footer style="max-width: 100%"><div class="row"><div class="large-6 columns" style="margin-bottom: .75em; margin-top: .75em"><ul class="unstyled"><li>&#169; Copyright 2013-2014 JavaEE Samples.</li><li><i class="fi-like"></i>&nbsp;Mixed with <a href="http://foundation.zurb.com/">Foundation</a>. Baked by <a href="http://awestruct.org">Awestruct</a>.</li><li><i class="fi-share"></i>&nbsp;Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</li></ul></div></div></footer><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.js"></script><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.topbar.js"></script><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.reveal.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/styles/pojoaque.css"><script type="text/javascript">$(document).foundation()</script><script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount','UA-18727998-5']);
_gaq.push(['_trackPageview']);
(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
</body>