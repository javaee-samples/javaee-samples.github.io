<!DOCTYPE html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>JavaEE Sample::Batch::Batch Chunk Exception</title><link rel="stylesheet" href="http://javaee-samples.github.io/stylesheets/foundation-icons.css"><link rel="stylesheet" href="http://javaee-samples.github.io/stylesheets/app.css"><script src="http://javaee-samples.github.io/javascripts/vendor/custom.modernizr.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><link rel="author" type="text/plain" href="http://javaee-samples.github.io/humans.txt"><link rel="author" href="https://plus.google.com/101195212405190467512"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Batch Chunk Exception"><meta name="twitter:description" content="Chunk Exception Handling - Retrying and Skipping"></head><body class="antialiased"><nav class="top-bar"><ul class="title-area"><li class="name"><h1><a href="http://javaee-samples.github.io/">JavaEE Samples</a></h1></li><li class="toggle-topbar"><a href="#"><i class="fi-home"></i></a></li></ul><section class="top-bar-section"><ul class="right"><li class="divider"><li><a href="http://javaee-samples.github.io/contributors">Contributors <i class="fi-torsos-male-female"></i></a></li></li></ul></section></nav><div class="container"><header><div class="row"><div class="large-10 columns"><h2>Batch Chunk Exception</h2></div><div class="large-2 columns"><div class="action right"><a class="button radius round success" data-reveal-id="run">Run <i class="fi-play"></i></a><div id="run" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to run the sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/batch/chunk-exception/">javaee7-samples</a> <i class="fi-social-github"></i>GitHub repository. The first thing we need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/batch/chunk-exception/</code></pre>Now we are ready to start testing. You can run all the tests in this sample by executing:<pre class="highlight"><code>mvn test</code></pre>Or you can run individual tests by executing one of the following:<pre class="highlight"><code>mvn test -Dtest=BatchChunkExceptionTest</code></pre></hr></div></div></div></div><div class="row"><div class="large-10 columns"><h3>Chunk Exception Handling - Retrying and Skipping</h3></div></div><div class="sub"><div class="row"><div class="large-10 columns specifications"><ul class="inline-list"><li>Specifications in use:</li><li><ul class="inline-list"></ul><li><a href="http://javaee-samples.github.io/#Batch" title="Batch Processing for Java Platform 1.0">Batch</a></li><li><a href="http://javaee-samples.github.io/#CDI" title="Context and Dependency Injection 1.1">CDI</a></li></li></ul></div><div class="large-2 columns contributors"><ul class="inline-list"><li itemscope="" itemtype="http://data-vocabulary.org/Person"><meta itemprop="role" content="author"><meta itemprop="name" content="Arun Gupta"><meta itemprop="affiliation" content="Red Hat Software"><img class="photo" title="Arun Gupta" src="http://gravatar.com/avatar/268f57c236bb50c0f6e12ac38adc9d81?s=25" itemprop="photo"></li><li itemscope="" itemtype="http://data-vocabulary.org/Person"><meta itemprop="role" content="author"><meta itemprop="name" content="Roberto Cortez"><meta itemprop="affiliation" content=""><img class="photo" title="Roberto Cortez" src="http://gravatar.com/avatar/d9a06fda174419c0dffb982f226518c2?s=25" itemprop="photo"></li></ul></div></div></div><script type="text/javascript">//$(function() { activateGuideMenuControl() })</script></header><div class="row"><div class="large-12 columns"><div id="test"><div class="row"><div class="large-7 columns"><h4>BatchChunkExceptionTest</h4></div><div class="large-3 columns"><ul class="inline-list" style="margin-left:0em;"><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on GlassFish 4.0" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly 8.0.0.Final" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly 8.1.0.Final" style="color: green"></i></li><li style="margin-left: 0.3em"><i class="fi-like" title="All tests pass on WildFly nightly" style="color: green"></i></li></ul></div><div class="large-2 columns"><a class="right" href="https://github.com/javaee-samples/javaee7-samples/edit/master/batch/chunk-exception/src/test/java/org/javaee7/batch/chunk/exception/BatchChunkExceptionTest.java"><i class="fi-page-edit"></i></a></div></div><div class="paragraph">
<p>Exceptions are a natural part of Batch Processing, and the batch itself should be prepared to deal with
exceptions during processing.</p>
</div>
<div class="paragraph">
<p>Batch Processing deals with two kinds of exceptions: skippable and retryable. Skippable Exceptions are used to skip
elements during reading, processing and writing and continue to the next element. Retryable Exceptions on the other
hand when thrown will try to retry the chunk on which the exception occurred.</p>
</div>
<div class="paragraph">
<p>When the same exception is specified as both retryable and skippable, retryable takes precedence over skippable
during regular processing of the chunk. While the chunk is retrying, skippable takes precedence over retryable since
the exception is already being retried.</p>
</div>
<div class="paragraph">
<p>The Reader:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Named()
public class MyItemReader extends AbstractItemReader {

    public MyItemReader() {
        super();
    }
    private StringTokenizer tokens;
    private MyInputRecord lastElement;
    private boolean alreadyFailed;

    @Override()
    public void open(Serializable checkpoint) {
        tokens = new StringTokenizer("1,2,3,4,5,6,7,8,9,10", ",");
        if (checkpoint != null) {
            while (!Integer.valueOf(tokens.nextToken()).equals(((MyInputRecord)checkpoint).getId())) {
                System.out.println("Skipping already read elements");
            }
        }
    }

    @Override()
    public Object readItem() {
        if (tokens.hasMoreTokens()) {
            int token = Integer.valueOf(tokens.nextToken());
            if (token == 5 &amp;&amp; !alreadyFailed) {
                alreadyFailed = true;
                throw new IllegalArgumentException("Could not read record");
            }
            lastElement = new MyInputRecord(token);
            System.out.println("MyItemReader.readItem " + lastElement);
            return lastElement;
        }
        return null;
    }

    @Override()
    public Serializable checkpointInfo() throws Exception {
        return lastElement;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just reads elements from a list and simulate a retry exception.</p>
</div>
<div class="paragraph">
<p>The Processor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Named()
public class MyItemProcessor implements ItemProcessor {

    public MyItemProcessor() {
        super();
    }

    @Override()
    public Object processItem(Object t) {
        System.out.println("MyItemProcessor.processItem: " + t);
        if (((MyInputRecord)t).getId() == 6) {
            throw new NullPointerException();
        }
        return new MyOutputRecord(((MyInputRecord)t).getId());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Process and simulate a skip exception.</p>
</div>
<div class="paragraph">
<p>The Writer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Named()
public class MyItemWriter extends AbstractItemWriter {

    public MyItemWriter() {
        super();
    }
    private static int retries = 0;

    @Override()
    public void writeItems(List list) {
        if (retries &lt;= 3 &amp;&amp; list.contains(new MyOutputRecord(8))) {
            retries++;
            System.out.println("Throw UnsupportedOperationException in MyItemWriter");
            throw new UnsupportedOperationException();
        }
        System.out.println("MyItemWriter.writeItems: " + list);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The writer will retry an exception and then skip it.</p>
</div>
<div class="paragraph">
<p>The batch specification also allows you to provide listeners for skipping and retrying for every operation. Have a
look into the following classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>MySkipReadListener</code></p>
</li>
<li>
<p><code>MySkipProcessorListener</code></p>
</li>
<li>
<p><code>MySkipWriteListener</code></p>
</li>
<li>
<p><code>MyRetryReadListener</code></p>
</li>
<li>
<p><code>MyRetryProcessorListener</code></p>
</li>
<li>
<p><code>MyRetryWriteListener</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Events can be caught via extending the following classes, for the appropriate batch lifecycle event:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/listener/SkipReadListener.html" title="javax.batch.api.chunk.listener.SkipReadListener">SkipReadListener</a></code></p>
</li>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/listener/SkipProcessListener.html" title="javax.batch.api.chunk.listener.SkipProcessListener">SkipProcessListener</a></code></p>
</li>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/listener/SkipWriteListener.html" title="javax.batch.api.chunk.listener.SkipWriteListener">SkipWriteListener</a></code></p>
</li>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/listener/RetryReadListener.html" title="javax.batch.api.chunk.listener.RetryReadListener">RetryReadListener</a></code></p>
</li>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/listener/RetryProcessListener.html" title="javax.batch.api.chunk.listener.RetryProcessListener">RetryProcessListener</a></code></p>
</li>
<li>
<p><code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/api/chunk/listener/RetryWriteListener.html" title="javax.batch.api.chunk.listener.RetryWriteListener">RetryWriteListener</a></code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="xml language-xml">&lt;job id="myJob" xmlns="http://xmlns.jcp.org/xml/ns/javaee" version="1.0"&gt;
    &lt;step id="myStep" &gt;
        &lt;listeners&gt;
            &lt;listener ref="mySkipReadListener"/&gt;
            &lt;listener ref="mySkipProcessorListener"/&gt;
            &lt;listener ref="mySkipWriteListener"/&gt;
            &lt;listener ref="myRetryReadListener"/&gt;
            &lt;listener ref="myRetryProcessorListener"/&gt;
            &lt;listener ref="myRetryWriteListener"/&gt;
        &lt;/listeners&gt;

        &lt;chunk checkpoint-policy="item" item-count="3" skip-limit="3" retry-limit="3"&gt;
            &lt;reader ref="myItemReader"/&gt;
            &lt;processor ref="myItemProcessor"/&gt;
            &lt;writer ref="myItemWriter"/&gt;
            &lt;skippable-exception-classes&gt;
                &lt;include class="java.lang.RuntimeException"/&gt;
                &lt;include class="java.lang.UnsupportedOperationException"/&gt;
            &lt;/skippable-exception-classes&gt;
            &lt;retryable-exception-classes&gt;
                &lt;include class="java.lang.IllegalArgumentException"/&gt;
                &lt;include class="java.lang.UnsupportedOperationException"/&gt;
            &lt;/retryable-exception-classes&gt;
        &lt;/chunk&gt;
    &lt;/step&gt;
&lt;/job&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A very simple job is defined in the <code>myJob.xml</code> file. Just a single step with a reader, a processor and a writer. For
this sample we are going to process a few records and mix some exceptions during read, processing and write of the
chunk. Batch exception handling is achieved by defining the elements <code>skippable-exception-classes</code> and
<code>retryable-exception-classes</code> into the <code>chunk</code>. Both elements should indicate the full qualified name of the
exceptions that we are trying to catch. The <code>listeners</code> element can be used at the <code>step</code> level to define which
listeners to run for each batch processing event.</p>
</div><div class="paragraph">
<p>We&#8217;re just going to deploy the application as a <code>web archive</code>. Note the inclusion of the following files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="file language-file">/META-INF/batch-jobs/myJob.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>myJob.xml</code> file is needed for running the batch definition.</p>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Deployment
public static WebArchive createDeployment() {
    WebArchive war = ShrinkWrap.create(WebArchive.class)
            .addClass(BatchTestHelper.class)
            .addPackage("org.javaee7.batch.chunk.exception")
            .addAsWebInfResource(EmptyAsset.INSTANCE, ArchivePaths.create("beans.xml"))
            .addAsResource("META-INF/batch-jobs/myJob.xml");
    System.out.println(war.toString(true));
    return war;
}</code></pre>
</div>
</div><div class="paragraph">
<p>In the test, we&#8217;re just going to invoke the batch execution and wait for completion. To validate the test
expected behaviour we need to query the <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/batch/runtime/Metric.html" title="javax.batch.runtime.Metric">Metric</a></code> object available in the step execution.</p>
</div><div class="listingblock">
<div class="content">
<pre class="highlight"><code class="java language-java">@Test
public void testBatchChunkException() throws Exception {
    JobOperator jobOperator = BatchRuntime.getJobOperator();
    Long executionId = jobOperator.start("myJob", new Properties());
    JobExecution jobExecution = jobOperator.getJobExecution(executionId);

    BatchTestHelper.keepTestAlive(jobExecution);

    List&lt;StepExecution&gt; stepExecutions = jobOperator.getStepExecutions(executionId);
    for (StepExecution stepExecution : stepExecutions) {
        if (stepExecution.getStepName().equals("myStep")) {
            Map&lt;Metric.MetricType, Long&gt; metricsMap = BatchTestHelper.getMetricsMap(stepExecution.getMetrics());

            assertEquals(1L, metricsMap.get(Metric.MetricType.PROCESS_SKIP_COUNT).longValue());
            // There are a few differences between Glassfish and Wildfly. Needs investigation.
            //assertEquals(1L, metricsMap.get(Metric.MetricType.WRITE_SKIP_COUNT).longValue());
            assertEquals(1L, ChunkExceptionRecorder.retryReadExecutions);
        }
    }

    assertTrue(ChunkExceptionRecorder.chunkExceptionsCountDownLatch.await(0, TimeUnit.SECONDS));
    assertEquals(BatchStatus.COMPLETED, jobExecution.getBatchStatus());
}</code></pre>
</div>
</div></div><script type="text/javascript">$(function() {
  hljs.initHighlightingOnLoad();
})</script></div></div><div class="row"><div class="large-12 columns"><div class="large-6 columns"><h3>Share the Knowledge</h3>Find this sample useful? <a href="http://twitter.com/home/?status=Just%20read%20the%20%23JavaEE-Sample%20%22Batch::Batch%20Chunk%20Exception%22%20and%20learned%20something%20new!%20http://javaee-samples.github.io/sample/batch-chunk-exception/">Share on <i class="fi-social-twitter"></i></a><p>There's a lot more about JavaEE to cover. If you're ready to learn more, check out the <a href="http://javaee-samples.github.io/">other available samples</a>.</p></div><div class="large-6 columns"><h3>Help Improve</h3>Find a bug in the sample? Something missing? You can fix it by <a href="https://github.com/javaee-samples/javaee7-samples/edit/master/batch/chunk-exception/src/test/java/org/javaee7/batch/chunk/exception/BatchChunkExceptionTest.java">editing the source</a>, making the correction and sending a pull request. Or report the problem to the <a href="https://github.com/javaee-samples/javaee7-samples/issues">issue tracker</a></div></div></div><div class="row"><div class="large-12 columns changes"><h4>Recent Changelog</h4><ul><li><div>Jun 20, 2014: Added fqn to java ee api references to generate direct links to javadocs <em>by radcortez</em></div></li><li><div>Jun 19, 2014: Documentation clarifications and typos <em>by radcortez</em></div></li><li><div>May 27, 2014: Fixed a few javadocs typos <em>by Roberto Cortez</em></div></li><li><div>May 08, 2014: Fixed chunk exception wildfly test <em>by Roberto Cortez</em></div></li><li><div>Apr 04, 2014: Fixed chunk exception test <em>by Roberto Cortez</em></div></li><li><div>Dec 31, 2013: Code style issues <em>by Roberto Cortez</em></div></li><li><div>Dec 31, 2013: Removed servlets and jsp's <em>by Roberto Cortez</em></div></li><li><div>Dec 11, 2013: Added test for chunk-exception project <em>by Roberto Cortez</em></div></li><li><div>Sep 17, 2013: Removing netbeans configuration file <em>by Arun Gupta</em></div></li><li><div>Sep 17, 2013: Improving output messages, adding copyrights and @author <em>by Arun Gupta</em></div></li></ul></div></div><div id="improve" class="hide reveal-modal" data-reveal=""><a class="close-reveal-modal" href="./">How to help improve this sample <i class="fi-x"></i></a><hr class="clear">The source code for this sample can be found in the <a href="https://github.com/javaee-samples/javaee7-samples/tree/master/batch/chunk-exception/">javaee7-samples</a> <i class="fi-social-github"></i>GitHub repository. The first thing you need to do is to get the source by downloading the repository and then go into the samples folder:<pre class="highlight"><code>git clone git://github.com/javaee-samples/javaee7-samples.git<br/>cd javaee7-samples/batch/chunk-exception/</code></pre><p>Do the changes as you see fit and send a pull request!</p><p>Good Luck!</p></hr></div></div><footer style="max-width: 100%"><div class="row"><div class="large-6 columns" style="margin-bottom: .75em; margin-top: .75em"><ul class="unstyled"><li>&#169; Copyright 2013-2014 JavaEE Samples.</li><li><i class="fi-like"></i>&nbsp;Mixed with <a href="http://foundation.zurb.com/">Foundation</a>. Baked by <a href="http://awestruct.org">Awestruct</a>.</li><li><i class="fi-share"></i>&nbsp;Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</li></ul></div></div></footer><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.js"></script><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.topbar.js"></script><script src="http://javaee-samples.github.io/javascripts/foundation/foundation.reveal.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/highlight.min.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/7.3/styles/pojoaque.css"><script type="text/javascript">$(document).foundation()</script><script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount','UA-18727998-5']);
_gaq.push(['_trackPageview']);
(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
</body>